<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบริหารจัดการตัวอย่างดิน - กลุ่มวิจัยเคมีดิน</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Custom Style -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #f8fafc; 
        }
        .btn-primary { @apply bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded transition-all duration-200 shadow-sm; }
        .btn-secondary { @apply bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded transition-all duration-200 shadow-sm; }
        .btn-danger { @apply bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-all duration-200 shadow-sm; }
        
        .status-badge { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; border-radius: 50px; font-size: 13px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.15); z-index: 40; display: flex; align-items: center; gap: 8px; }
        .status-online { background-color: #10b981; color: white; }
        
        .nav-item.active { background-color: #059669; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .nav-item-highlight { background-color: #fffbeb; color: #92400e; border: 1px solid #fcd34d; font-weight: bold; }
        .nav-item-highlight:hover { background-color: #fef3c7; }
        .nav-item-highlight.active { background-color: #d97706; color: white; border-color: #b45309; }

        .item-checkbox { width: 1.2rem; height: 1.2rem; cursor: pointer; accent-color: #10b981; }
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .table-responsive { overflow-x: auto; background-color: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="text-gray-800 h-screen flex overflow-hidden">

    <!-- Mobile Navigation Overlay -->
    <div id="mobile-overlay" class="fixed inset-0 bg-slate-900/50 z-40 hidden md:hidden" onclick="toggleSidebar()"></div>

    <!-- Sidebar Menu -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-800 text-white flex-col flex z-50 transform -translate-x-full md:translate-x-0 md:relative shadow-2xl">
        <div class="p-6 border-b border-slate-700 flex items-center space-x-3">
            <div class="w-10 h-10 bg-emerald-500 rounded-lg flex items-center justify-center shadow-lg shadow-emerald-500/20">
                <i class="fa-solid fa-flask-vial text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">Soilsheif Pro</h1>
                <p class="text-xs text-slate-400">Soil Research Group</p>
            </div>
        </div>
        
        <nav class="flex-1 p-4 space-y-1.5 overflow-y-auto" id="nav-container">
            <!-- JavaScript will inject navigation items here -->
        </nav>
        
        <div class="p-4 border-t border-slate-700 bg-slate-800/50">
            <div class="flex items-center space-x-3 mb-4 cursor-pointer hover:bg-slate-700 p-2 rounded-lg transition-colors" onclick="router('profile')">
                <div class="w-9 h-9 bg-emerald-600 rounded-full flex items-center justify-center font-bold border-2 border-slate-600" id="user-avatar">U</div>
                <div class="flex-1 overflow-hidden">
                    <p id="nav-username" class="text-sm font-semibold truncate">Guest</p>
                    <p class="text-[10px] text-slate-400 uppercase tracking-wider">Account Settings</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full bg-red-600/10 hover:bg-red-600 text-red-500 hover:text-white py-2 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2 border border-red-600/20">
                <i class="fa-solid fa-right-from-bracket"></i> ออกจากระบบ
            </button>
        </div>
    </aside>

    <!-- Content Main Area -->
    <main class="flex-1 flex flex-col overflow-hidden relative w-full">
        <!-- Header Nav -->
        <header class="bg-white border-b border-slate-200 p-4 flex justify-between items-center z-20">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="text-slate-600 p-2 rounded-lg hover:bg-slate-100 md:hidden">
                    <i class="fa-solid fa-bars-staggered text-xl"></i>
                </button>
                <div id="header-title" class="font-bold text-slate-800 text-lg md:text-xl">
                    Dashboard Overview
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="hidden sm:block text-right">
                    <p class="text-xs text-slate-400 font-medium">SERVER TIME</p>
                    <p class="text-sm text-slate-700 font-bold" id="clock">00:00:00</p>
                </div>
            </div>
        </header>
        
        <!-- Application Content -->
        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 relative">
            <!-- Dynamic Content -->
        </div>

        <!-- Connection Badge -->
        <div id="status-badge" class="status-badge status-online">
            <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
            <span>ออนไลน์ (Server)</span>
        </div>
    </main>

    <!-- Global Loading -->
    <div id="loading-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center">
            <div class="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-slate-800 font-bold text-lg" id="loading-text">กำลังโหลดข้อมูล...</p>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container"></div>

    <!-- Login/Auth Screen -->
    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col">
            <div class="bg-gradient-to-br from-emerald-600 to-emerald-800 p-8 text-white text-center">
                <i class="fa-solid fa-flask-vial text-5xl mb-4"></i>
                <h2 class="text-3xl font-bold">กลุ่มวิจัยเคมีดิน</h2>
                <p class="text-emerald-100/80 text-sm mt-1">Soilsheif Lab Management System</p>
            </div>
            <div class="p-8">
                <div class="flex mb-8 bg-slate-100 p-1 rounded-xl">
                    <button onclick="showLoginTab('login')" id="tab-login" class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all bg-white text-emerald-700 shadow-sm">เข้าสู่ระบบ</button>
                    <button onclick="showLoginTab('register')" id="tab-register" class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-emerald-600">ลงทะเบียน</button>
                </div>
                
                <form id="login-form" onsubmit="handleLogin(event)" class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">ชื่อผู้ใช้ (Username)</label>
                        <input type="text" id="login-user" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">รหัสผ่าน (Password)</label>
                        <input type="password" id="login-pass" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all" required>
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="flex items-center cursor-pointer group">
                            <input type="checkbox" id="remember-me" class="w-4 h-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500">
                            <span class="ml-2 text-sm text-slate-600 group-hover:text-emerald-700 transition-colors">จำการเข้าระบบ</span>
                        </label>
                    </div>
                    <div id="login-error-msg" class="hidden bg-red-50 border border-red-200 text-red-600 p-3 rounded-xl text-center text-sm font-medium animate-bounce">
                        ข้อมูลไม่ถูกต้อง กรุณาตรวจสอบอีกครั้ง
                    </div>
                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg shadow-emerald-600/20 active:scale-[0.98]">
                        เข้าสู่ระบบ
                    </button>
                </form>

                <form id="register-form" onsubmit="handleRegister(event)" class="space-y-4 hidden">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ชื่อผู้ใช้</label>
                        <input type="text" id="reg-user" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500" required>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">รหัสผ่าน</label>
                            <input type="password" id="reg-pass" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ยืนยันรหัส</label>
                            <input type="password" id="reg-pass-confirm" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ชื่อ-นามสกุล</label>
                        <input type="text" id="reg-name" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">กลุ่มงาน</label>
                        <select id="reg-group" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="ฝ่ายบริหารทั่วไป">ฝ่ายบริหารทั่วไป</option>
                            <option value="กลุ่มวิจัยเคมีดิน">กลุ่มวิจัยเคมีดิน</option>
                            <option value="กลุ่มวิจัยกายภาพดิน">กลุ่มวิจัยกายภาพดิน</option>
                            <option value="กลุ่มวิจัยสิ่งแวดล้อม">กลุ่มวิจัยสิ่งแวดล้อม</option>
                            <option value="กลุ่มวิเคราะห์ วิจัย พืช ปุ๋ย และสิ่งปรับปรุงดิน">กลุ่มวิเคราะห์ วิจัย พืช ปุ๋ย และสิ่งปรับปรุงดิน</option>
                            <option value="กลุ่มวิจัยแร่และจุลสัณฐานดิน">กลุ่มวิจัยแร่และจุลสัณฐานดิน</option>
                            <option value="กลุ่มมาตรฐานและพัฒนาระบบการวิเคราะห์">กลุ่มมาตรฐานและพัฒนาระบบการวิเคราะห์</option>
                            <option value="กลุ่มวิทยบริการ">กลุ่มวิทยบริการ</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all">ลงทะเบียนบัญชีใหม่</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzb3O1kWnyJtD7jPor_rfnJOrD9df1Jzjb66QtBXeIzgyKZHXRq8FramTk6RGptFCRKLQ/exec";
        const SECONDARY_DB_URL = "https://docs.google.com/spreadsheets/d/1mPcLcY-vC3_xpSg8BKYplGoENP4U_koiOgiUKu33P4Q/edit?gid=418256453#gid=418256453";
        const DEPARTMENTS = ["ฝ่ายบริหารทั่วไป", "กลุ่มวิจัยเคมีดิน", "กลุ่มวิจัยกายภาพดิน", "กลุ่มวิจัยสิ่งแวดล้อม", "กลุ่มวิเคราะห์ วิจัย พืช ปุ๋ย และสิ่งปรับปรุงดิน", "กลุ่มวิจัยแร่และจุลสัณฐานดิน", "กลุ่มมาตรฐานและพัฒนาระบบการวิเคราะห์", "กลุ่มวิทยบริการ"];
        
        let isRealMode = true; // PRODUCTION MODE
        let currentUser = null;
        let items = [];
        let events = [];
        let userList = [];
        let docSettings = {};
        
        let currentView = 'dashboard';
        let currentPage = 1;
        let searchTerm = '';
        let rowsPerPage = 20;

        // Chart References
        let statusChartInst = null;
        let rsChartInst = null;
        let rrChartInst = null;
        let repChartInst = null;
        let uaChartInst = null;

        // ==========================================
        // 2. HELPER FUNCTIONS
        // ==========================================
        function showLoading(text = "กำลังโหลดข้อมูล...") {
            const overlay = document.getElementById('loading-overlay');
            const txt = document.getElementById('loading-text');
            if (overlay && txt) {
                txt.textContent = text;
                overlay.classList.remove('hidden');
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.add('hidden');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar.classList.contains('-translate-x-full') && window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
                document.getElementById('mobile-overlay').classList.add('hidden');
            }
        }

        function updateStatusBadge() {
            const badge = document.getElementById('status-badge');
            if (badge) {
                badge.classList.remove('hidden');
            }
        }

        function formatDateTh(dateString, includeTime = true) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            if (includeTime) {
                options.hour = '2-digit';
                options.minute = '2-digit';
                options.hour12 = false;
            }
            return date.toLocaleString('th-TH', options);
        }

        function formatDateForPDF(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            return `${String(date.getDate()).padStart(2,'0')}/${String(date.getMonth()+1).padStart(2,'0')}/${date.getFullYear()}`;
        }

        function calculateDaysRemaining(dateReported) {
            if (!dateReported) return -1;
            const reported = new Date(dateReported);
            const now = new Date();
            const diffTime = Math.abs(now - reported);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function getUserInfo(username) {
            if (username === 'admin') return { name: 'Admin System', group: 'IT Support' };
            const u = userList.find(user => user.username === username);
            return u ? { name: u.name, group: u.group } : { name: username, group: '-' };
        }

        function updateRowsPerPage(val) {
            rowsPerPage = parseInt(val);
            currentPage = 1;
            renderContent();
        }

        function changePage(n) {
            currentPage = n;
            updateTableData();
        }

        function handleSearch(t) {
            searchTerm = t.toLowerCase();
            currentPage = 1;
            updateTableData();
        }

        // ** Added Missing Function **
        function updateNavAndRedirect() {
            renderSidebar();
            if(currentUser) {
                document.getElementById('nav-username').textContent = currentUser.name;
                document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
            }
            refreshData().then(() => router('dashboard'));
        }

        function updateNavUser() {
            if (currentUser) document.getElementById('nav-username').textContent = currentUser.name;
        }

        function showLoginTab(tab) {
            document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', tab !== 'register');
            document.getElementById('tab-login').className = tab === 'login' ? "flex-1 py-2.5 rounded-lg text-sm font-bold bg-white text-emerald-700 shadow-sm" : "flex-1 py-2.5 rounded-lg text-sm font-bold text-slate-500";
            document.getElementById('tab-register').className = tab === 'register' ? "flex-1 py-2.5 rounded-lg text-sm font-bold bg-white text-emerald-700 shadow-sm" : "flex-1 py-2.5 rounded-lg text-sm font-bold text-slate-500";
        }

        function logout() {
            localStorage.removeItem('soilAppUser');
            location.reload();
        }

        // --- 3. API COMMUNICATION ---
        async function apiCall(action, payload = {}, showSpinner = true) {
            if (showSpinner) showLoading();
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); 

                const response = await fetch(API_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ action, ...payload }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                
                const text = await response.text();
                const data = JSON.parse(text);
                
                if (showSpinner) hideLoading();
                return data;
            } catch (e) {
                if (showSpinner) hideLoading();
                console.error("API Call Error:", e);
                return { status: 'error', message: e.name === 'AbortError' ? "การเชื่อมต่อหมดเวลา" : e.message };
            }
        }

        async function refreshData() {
            try {
                const [iRes, eRes, uRes, sRes] = await Promise.all([
                    apiCall('getItems', {}, false),
                    apiCall('getHistory', {}, false),
                    apiCall('getUsers', {}, false),
                    apiCall('getSettings', {}, false)
                ]);

                if (iRes.status === 'success') items = iRes.items || [];
                if (eRes.status === 'success') events = eRes.events || [];
                if (uRes.status === 'success') userList = uRes.users || [];
                if (sRes.status === 'success') docSettings = sRes.settings || {};
            } catch (err) {
                console.error("Refresh Data Error:", err);
            } finally {
                hideLoading();
            }
        }

        async function loadThaiFont(doc) {
            try {
                const res = await fetch("https://raw.githubusercontent.com/google/fonts/main/ofl/sarabun/Sarabun-Regular.ttf");
                if (!res.ok) throw new Error("Font fetch failed");
                const blob = await res.blob();
                const reader = new FileReader();
                return new Promise(resolve => {
                    reader.onload = function() {
                        const base64 = reader.result.split(',')[1];
                        doc.addFileToVFS('Sarabun-Regular.ttf', base64);
                        doc.addFont('Sarabun-Regular.ttf', 'Sarabun', 'normal');
                        doc.setFont('Sarabun');
                        resolve();
                    };
                    reader.readAsDataURL(blob);
                });
            } catch (e) {
                console.error("Error loading font:", e);
                alert("ไม่สามารถโหลดฟอนต์ภาษาไทยได้");
            }
        }

        // --- 4. ACTION HANDLERS ---
        async function handleLogin(e) {
            e.preventDefault();
            document.getElementById('login-error-msg').classList.add('hidden');
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            const remember = document.getElementById('remember-me').checked;

            showLoading("กำลังตรวจสอบข้อมูล...");
            const res = await apiCall('login', { username: user, password: pass }, false);
            if (res.status === 'success') {
                showLoading("กำลังเข้าสู่ระบบ...");
                currentUser = res.user;
                if (remember) localStorage.setItem('soilAppUser', JSON.stringify(currentUser));
                
                document.getElementById('login-screen').classList.add('hidden');
                updateNavAndRedirect();
            } else {
                hideLoading();
                const errorDiv = document.getElementById('login-error-msg');
                errorDiv.querySelector('span').textContent = res.message || "ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง";
                errorDiv.classList.remove('hidden');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const pass = document.getElementById('reg-pass').value;
            const passConf = document.getElementById('reg-pass-confirm').value;

            if (pass !== passConf) {
                alert("รหัสผ่านไม่ตรงกัน");
                return;
            }
            const payload = {
                username: document.getElementById('reg-user').value,
                password: pass,
                name: document.getElementById('reg-name').value,
                group: document.getElementById('reg-group').value
            };
            const res = await apiCall('register', payload);
            if (res.status === 'success') {
                alert('ลงทะเบียนสำเร็จ! โปรดแจ้ง Admin เพื่ออนุมัติ');
                showLoginTab('login');
            } else {
                alert(res.message);
            }
        }

        async function processTransaction(type, itemId) {
            if (!itemId) return alert('รหัสสินค้าไม่ถูกต้อง');
            const action = type === 'borrow' ? 'borrowItem' : 'returnItem';
            const res = await apiCall(action, { itemId: itemId, username: currentUser.username });
            if (res.status === 'success') {
                alert('สำเร็จ');
                await refreshData();
                router('borrow');
            } else {
                alert(res.message);
            }
        }

        async function handleSaveItem(e, id) {
            e.preventDefault();
            const newItem = {
                id: id,
                receiptNo: document.getElementById('m-receipt').value,
                dateReceived: document.getElementById('m-date').value,
                qty: document.getElementById('m-qty').value,
                layer: "'" + document.getElementById('m-layer').value,
                params: document.getElementById('m-params').value,
                disposalPref: document.getElementById('m-pref').value
            };
            const action = id ? 'editItem' : 'addItem';
            const res = await apiCall(action, { item: newItem });
            if (res.status === 'success') {
                document.getElementById('modal-container').innerHTML = '';
                await refreshData();
                router('items');
            } else {
                alert(res.message);
            }
        }

        async function handleDisposeItem(id) {
            if(!confirm('ยืนยันดำเนินการจำหน่าย/คืนตัวอย่าง?')) return;
            const res = await apiCall('disposeItem', { id: id });
            if(res.status === 'success') {
                alert('เรียบร้อย');
                await refreshData();
                router(currentView);
            } else {
                alert(res.message);
            }
        }

        async function deleteItem(id) {
            if (!confirm('ยืนยันที่จะลบรายการนี้ถาวร?')) return;
            const res = await apiCall('deleteItem', { id: id });
            if (res.status === 'success') {
                await refreshData();
                router(currentView);
            } else {
                alert(res.message);
            }
        }

        async function deleteEvent(id) {
            if(!confirm('ยืนยันลบประวัติถาวร?')) return;
            const res = await apiCall('deleteEvent', { id: id });
            if (res.status === 'success') {
                await refreshData();
                router('history');
            } else {
                alert(res.message);
            }
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            const pass = document.getElementById('edit-pass').value;
            const updateData = {
                username: currentUser.username,
                name: document.getElementById('edit-name').value,
                group: document.getElementById('edit-group').value,
                password: pass ? pass : currentUser.password
            };
            const res = await apiCall('updateProfile', updateData);
            if (res.status === 'success') {
                currentUser.name = updateData.name;
                currentUser.group = updateData.group;
                if (pass) currentUser.password = pass;
                localStorage.setItem('soilAppUser', JSON.stringify(currentUser));
                alert('แก้ไขข้อมูลสำเร็จ');
                updateNavUser();
            } else {
                alert(res.message);
            }
        }
        
        // --- 5. RENDER LOGIC ---
        function renderSidebar() {
            const nav = document.getElementById('nav-container');
            const isAdmin = currentUser?.username === 'admin';
            
            let html = `
                <button id="nav-dashboard" onclick="router('dashboard')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 flex items-center gap-3 transition-all"><i class="fa-solid fa-chart-pie w-5"></i> แดชบอร์ด</button>
                <button id="nav-borrow" onclick="router('borrow')" class="nav-item-highlight w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 mb-2"><i class="fa-solid fa-hand-holding w-5"></i> เบิก-คืน ตัวอย่าง</button>
                <button id="nav-status" onclick="router('status')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 flex items-center gap-3"><i class="fa-solid fa-list-check w-5"></i> สถานะตัวอย่าง</button>
                <button id="nav-report" onclick="router('report')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 flex items-center gap-3 text-blue-300"><i class="fa-solid fa-clipboard-check w-5"></i> รายงานผลวิเคราะห์</button>
                <button id="nav-dispose" onclick="router('dispose')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 flex items-center gap-3 text-orange-300"><i class="fa-solid fa-trash-can-arrow-up w-5"></i> จำหน่ายตัวอย่าง</button>
                <button id="nav-return_customer" onclick="router('return_customer')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 flex items-center gap-3 text-teal-300"><i class="fa-solid fa-rotate-left w-5"></i> คืนตัวอย่าง</button>
                <button id="nav-items" onclick="router('items')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 flex items-center gap-3 text-emerald-300"><i class="fa-solid fa-box-archive w-5"></i> จัดการข้อมูลดิน</button>
            `;
            if (isAdmin) {
                html += `<div class="my-2 border-t border-slate-700"></div><button id="nav-users" onclick="router('users')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 flex items-center gap-3 text-purple-300"><i class="fa-solid fa-users-gear w-5"></i> จัดการผู้ใช้งาน</button>`;
            }
            html += `<button id="nav-history" onclick="router('history')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 flex items-center gap-3"><i class="fa-solid fa-clock-rotate-left w-5"></i> ประวัติการทำงาน</button>`;
            nav.innerHTML = html;
        }

        async function router(view) {
            currentView = view; currentPage = 1; searchTerm = ''; closeSidebar();
            const titles = { 'dashboard':'แดชบอร์ด','status':'สถานะตัวอย่าง','items':'จัดการตัวอย่างดิน','borrow':'เบิก-คืน','return_customer':'คืนตัวอย่าง','dispose':'จำหน่ายตัวอย่าง','report':'รายงานผล','history':'ประวัติ','users':'จัดการผู้ใช้','profile':'ข้อมูลส่วนตัว' };
            document.getElementById('header-title').textContent = titles[view] || 'Soilsheif Pro';
            
            document.querySelectorAll('.nav-item, .nav-item-highlight').forEach(e => e.classList.remove('active'));
            const activeNav = document.getElementById('nav-' + view);
            if(activeNav) activeNav.classList.add('active');

            if (view === 'dashboard') renderDashboard();
            else renderContent();
        }

        function renderDashboard() {
            const container = document.getElementById('content-area');
            let totalQty = 0, borrowedQty = 0, availableQty = 0;
            items.forEach(i => {
                const q = Number(i.qty) || 0;
                totalQty += q;
                if(i.status === 'Borrowed') borrowedQty += q;
                else availableQty += q;
            });

            // Monthly Stats Logic
            const mn = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
            const monthlyData = {};
            
            items.forEach(i => {
                if(i.dateReceived) {
                    const d = new Date(i.dateReceived);
                    if(!isNaN(d)) {
                        const k = `${mn[d.getMonth()]} ${d.getFullYear()+543}`;
                        if(!monthlyData[k]) monthlyData[k] = { smp:0, rec:0, rep:0, sort: d.getTime() };
                        monthlyData[k].rec++;
                        monthlyData[k].smp += (Number(i.qty) || 0);
                    }
                }
                if(i.dateReported) {
                    const d = new Date(i.dateReported);
                    if(!isNaN(d)) {
                        const k = `${mn[d.getMonth()]} ${d.getFullYear()+543}`;
                        if(!monthlyData[k]) monthlyData[k] = { smp:0, rec:0, rep:0, sort: d.getTime() };
                        monthlyData[k].rep += (Number(i.qty) || 0);
                    }
                }
            });
            const sortedKeys = Object.keys(monthlyData).sort((a,b) => monthlyData[a].sort - monthlyData[b].sort);

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-emerald-500"><div><p class="text-xs font-bold text-slate-400 uppercase">ใบรายการรวม</p><p class="text-3xl font-black text-slate-800">${items.length}</p></div></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-cyan-500"><div><p class="text-xs font-bold text-slate-400 uppercase">ตัวอย่างดินรวม</p><p class="text-3xl font-black text-slate-800">${totalQty}</p></div></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-blue-500"><div><p class="text-xs font-bold text-slate-400 uppercase">พร้อมเบิก (ตัวอย่าง)</p><p class="text-3xl font-black text-slate-800">${availableQty}</p></div></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-orange-500"><div><p class="text-xs font-bold text-slate-400 uppercase">ถูกเบิก (ตัวอย่าง)</p><p class="text-3xl font-black text-slate-800">${borrowedQty}</p></div></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm h-96">
                        <h3 class="font-bold text-slate-700 mb-4">สถานะตัวอย่าง (ผลรวมจำนวนดิน)</h3>
                        <div class="h-72"><canvas id="statusChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm h-96">
                        <h3 class="font-bold text-slate-700 mb-4">สถิติการรับตัวอย่างรายเดือน</h3>
                        <div class="h-72"><canvas id="recChart"></canvas></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm"><h3 class="font-bold text-slate-700 mb-4">สถิติการรายงานผลรายเดือน</h3><div class="h-72"><canvas id="repChart"></canvas></div></div>
            `;

            setTimeout(() => {
                Chart.register(ChartDataLabels);
                if(statusChartInst) statusChartInst.destroy();
                statusChartInst = new Chart(document.getElementById('statusChart').getContext('2d'), {
                    type: 'doughnut',
                    data: { labels:['พร้อมเบิก','ถูกเบิก'], datasets:[{data:[availableQty, borrowedQty], backgroundColor:['#10b981','#f97316'], borderWidth:0}]},
                    options: { responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{ datalabels:{color:'#fff', font:{weight:'bold', size:14}}}}
                });

                const barOpts = {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { top: 35 } },
                    scales: { y: { beginAtZero: true, grace: '20%' } },
                    plugins: { legend:{display:false}, datalabels:{anchor:'end', align:'top', color:'#475569', font:{weight:'bold'}, offset:4} }
                };

                if(rsChartInst) rsChartInst.destroy();
                rsChartInst = new Chart(document.getElementById('recChart').getContext('2d'), {
                    type:'bar', data:{labels:sortedKeys, datasets:[{label:'ตัวอย่าง', data:sortedKeys.map(k=>monthlyData[k].smp), backgroundColor:'#0ea5e9', borderRadius:6}]},
                    options: barOpts
                });

                if(repChartInst) repChartInst.destroy();
                repChartInst = new Chart(document.getElementById('repChart').getContext('2d'), {
                    type:'bar', data:{labels:sortedKeys, datasets:[{label:'ตัวอย่าง', data:sortedKeys.map(k=>monthlyData[k].rep), backgroundColor:'#10b981', borderRadius:6}]},
                    options: barOpts
                });
            }, 150);
        }

        function renderContent() {
            const container = document.getElementById('content-area');
            const isAdmin = currentUser.username === 'admin';
            const canAct = isAdmin || (currentView === 'items' && currentUser.canManage) || (currentView === 'report' && currentUser.canReport) || (['dispose','return_customer'].includes(currentView) && currentUser.canDispose);
            const pg = `<select onchange="updateRowsPerPage(this.value)" class="p-2 border rounded-lg text-xs ml-2 bg-white outline-none"><option value="20" ${rowsPerPage==20?'selected':''}>20 แถว</option><option value="50" ${rowsPerPage==50?'selected':''}>50 แถว</option><option value="100" ${rowsPerPage==100?'selected':''}>100 แถว</option><option value="10000" ${rowsPerPage==10000?'selected':''}>ทั้งหมด</option></select>`;

            let toolbar = `
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div class="flex items-center w-full md:w-auto bg-white p-1 rounded-xl shadow-sm border">
                        <i class="fa-solid fa-magnifying-glass ml-3 text-slate-400"></i>
                        <input type="text" oninput="handleSearch(this.value)" value="${searchTerm}" placeholder="ค้นหาข้อมูล..." class="p-2 bg-transparent outline-none text-sm w-full md:w-64">
                        ${pg}
                    </div>
                    <div class="flex gap-2 items-center">
                        <div class="flex bg-white rounded-xl shadow-sm border p-1 items-center">
                            <button onclick="exportViewXLSX()" class="px-3 py-1.5 text-slate-500 hover:text-emerald-600 rounded-lg transition-colors" title="Excel"><i class="fa-solid fa-file-excel text-lg"></i></button>
                            <div class="w-px h-6 bg-slate-200 mx-1"></div>
                            <button onclick="exportViewPDF()" class="px-3 py-1.5 text-slate-500 hover:text-red-600 rounded-lg transition-colors" title="PDF"><i class="fa-solid fa-file-pdf text-lg"></i></button>
                            ${(isAdmin && ['items','report','dispose','return_customer','history','users','status'].includes(currentView)) ? `<button onclick="openSettingsModal('${currentView}')" class="ml-2 btn-secondary text-xs px-2.5 py-1.5 rounded-lg"><i class="fa-solid fa-cog"></i></button>` : ''}
                        </div>
                        ${(currentView==='items' && isAdmin) ? `<button onclick="openItemModal()" class="btn-primary flex items-center gap-2"><i class="fa-solid fa-plus"></i> เพิ่มข้อมูล</button>
                        <button onclick="deleteSelected('item')" id="btn-delete-items" class="btn-danger hidden flex items-center gap-2 animate-pulse"><i class="fa-solid fa-trash-can"></i> ลบที่เลือก</button>` : ''}
                        ${(isAdmin && ['history','dispose','return_customer'].includes(currentView)) ? `<button onclick="deleteSelected('event')" id="btn-delete-${currentView==='return_customer'?'return':currentView}" class="btn-danger hidden flex items-center gap-2 animate-pulse"><i class="fa-solid fa-trash-can"></i> ลบที่เลือก</button>` : ''}
                    </div>
                </div>`;

            if(currentView === 'borrow') {
                container.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-full"><div class="bg-white p-6 rounded-2xl shadow-sm flex flex-col"><h3 class="text-lg font-bold mb-4 text-emerald-700 flex items-center gap-2"><i class="fa-solid fa-search"></i> เบิกตัวอย่าง</h3><input type="text" oninput="handleSearch(this.value)" placeholder="พิมพ์เลขรับ หรือ ชั้นเก็บ..." class="w-full p-3 border rounded-xl mb-4 outline-none focus:ring-2 focus:ring-emerald-500"><div class="flex-1 overflow-y-auto"><table class="w-full text-left text-sm"><thead><tr class="border-b"><th class="pb-2">เลขรับ</th><th class="pb-2">Qty</th><th class="pb-2">ชั้น</th><th class="pb-2 text-right">เลือก</th></tr></thead><tbody id="borrow-list-body"></tbody></table></div></div><div class="bg-white p-6 rounded-2xl shadow-sm flex flex-col h-fit"><h3 class="text-lg font-bold mb-4 text-blue-700 flex items-center gap-2"><i class="fa-solid fa-hand-holding"></i> คืนตัวอย่าง</h3><div class="overflow-y-auto max-h-[500px]"><table class="w-full text-left text-sm"><thead><tr class="border-b"><th class="pb-2">เลขรับ</th><th class="pb-2">Qty</th><th class="pb-2 text-right">คืน</th></tr></thead><tbody id="return-list-body"></tbody></table></div></div></div>`;
                updateTableData();
                return;
            } else if(currentView === 'profile') {
                container.innerHTML = `<div class="bg-white max-w-2xl mx-auto p-8 rounded-3xl shadow-sm border border-slate-100"><h3 class="text-xl font-bold mb-6 text-slate-800">ข้อมูลส่วนตัว</h3><form onsubmit="handleProfileUpdate(event)" class="space-y-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Username</label><input type="text" value="${currentUser.username}" disabled class="w-full p-3 bg-slate-100 border border-slate-200 rounded-xl"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">กลุ่มงาน</label><select id="edit-group" class="w-full p-3 border rounded-xl outline-none">${DEPARTMENTS.map(g=>`<option value="${g}" ${currentUser.group===g?'selected':''}>${g}</option>`).join('')}</select></div></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">ชื่อ-นามสกุล</label><input type="text" id="edit-name" value="${currentUser.name}" class="w-full p-3 border rounded-xl outline-none"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">รหัสผ่านใหม่</label><input type="password" id="edit-pass" class="w-full p-3 border rounded-xl outline-none"></div><button type="submit" class="btn-primary w-full py-4 text-lg">บันทึก</button></form></div>`;
                return;
            }

            let th = '';
            if(currentView==='status') th = `<tr><th class="p-4">เลขรับ</th><th class="p-4">Qty</th><th class="p-4">ชั้น</th><th class="p-4">สถานะ</th><th class="p-4">ผู้เบิก</th><th class="p-4">พารามิเตอร์</th><th class="p-4">วันที่รายงาน</th></tr>`;
            else if(currentView==='items') th = `<tr><th class="p-4 w-10"><input type="checkbox" onchange="toggleAllItems(this,'btn-delete-items')"></th><th class="p-4">เลขรับ</th><th class="p-4">Qty</th><th class="p-4">ชั้น</th><th class="p-4">วันที่รับ</th><th class="p-4">จำหน่ายโดย</th><th class="p-4 text-center">จัดการ</th></tr>`;
            else if(currentView==='report') th = `<tr><th class="p-4">เลขรับ</th><th class="p-4">วันที่รับ</th><th class="p-4">พารามิเตอร์</th><th class="p-4 text-center">จัดการ</th></tr>`;
            else if(currentView==='history') th = `<tr><th class="p-4 w-10">${isAdmin?`<input type="checkbox" onchange="toggleAllItems(this,'btn-delete-history')">`:''}</th><th class="p-4">เวลา</th><th class="p-4">รายการ</th><th class="p-4">เลขรับ</th><th class="p-4">ผู้ทำ</th><th class="p-4">ชื่อ</th><th class="p-4">หมายเหตุ</th><th class="p-4 text-center">จัดการ</th></tr>`;
            else if(['dispose','return_customer'].includes(currentView)) {
                let delId = currentView==='return_customer'?'btn-delete-return':'btn-delete-dispose';
                th = `<tr><th class="p-4 w-10">${canAct?`<input type="checkbox" onchange="toggleAllItems(this,'${delId}')">`:''}</th><th class="p-4">เลขรับ</th><th class="p-4">Qty</th><th class="p-4">ชั้น</th><th class="p-4">วันที่รายงาน</th><th class="p-4">เกินกำหนด</th><th class="p-4 text-center">จัดการ</th></tr>`;
            } else if(currentView==='users') th = `<tr><th class="p-4">Username</th><th class="p-4">ชื่อ</th><th class="p-4">กลุ่ม</th><th class="p-4">สถานะ</th><th class="p-4 text-center">รายงาน</th><th class="p-4 text-center">จัดการ</th><th class="p-4 text-center">จำหน่าย</th><th class="p-4 text-center">Action</th></tr>`;

            container.innerHTML = toolbar + `<div class="bg-white rounded-xl shadow-sm overflow-hidden"><div class="table-responsive"><table class="w-full text-left text-sm border-collapse"><thead class="bg-slate-50 text-slate-500 font-bold border-b uppercase text-[11px] tracking-wider">${th}</thead><tbody id="data-body" class="divide-y divide-slate-100"></tbody></table></div></div><div id="pagination-controls"></div>`;
            updateTableData();
        }

        function renderPagination(total, funcName) { 
            const pages = Math.ceil(total / rowsPerPage); 
            if (pages <= 1) return ''; 
            return `<div class="flex justify-center items-center gap-2 mt-4 p-4"><button onclick="${funcName}(${currentPage - 1})" ${currentPage === 1 ? 'disabled class="opacity-50 cursor-not-allowed"' : ''} class="px-3 py-1 bg-white border rounded hover:bg-gray-50"><i class="fa-solid fa-chevron-left"></i></button><span class="text-sm text-gray-600">หน้า ${currentPage} จาก ${pages}</span><button onclick="${funcName}(${currentPage + 1})" ${currentPage === pages ? 'disabled class="opacity-50 cursor-not-allowed"' : ''} class="px-3 py-1 bg-white border rounded hover:bg-gray-50"><i class="fa-solid fa-chevron-right"></i></button></div>`; 
        }

        function updateTableData() {
            const tbody = document.getElementById('data-body');
            const bBody = document.getElementById('borrow-list-body');
            const rBody = document.getElementById('return-list-body');
            
            if(currentView === 'borrow') {
                const av = items.filter(i => i.status === 'Available');
                const br = items.filter(i => i.status === 'Borrowed' && i.holder === currentUser.username);
                const s = searchTerm.toLowerCase();
                const fAv = av.filter(i => !s || i.receiptNo.toLowerCase().includes(s));
                
                if(bBody) bBody.innerHTML = fAv.length === 0 ? '<tr><td colspan="4" class="p-4 text-center text-slate-400">ไม่พบตัวอย่าง</td></tr>' : fAv.map(i => `<tr><td class="py-3 font-bold">${i.receiptNo}</td><td>${i.qty}</td><td class="text-slate-500">${i.layer}</td><td class="text-right"><button onclick="processTransaction('borrow','${i.id}')" class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-emerald-600 hover:text-white transition-all">เบิก</button></td></tr>`).join('');
                if(rBody) rBody.innerHTML = br.length === 0 ? '<tr><td colspan="3" class="p-4 text-center text-slate-400">ไม่มีรายการ</td></tr>' : br.map(i => `<tr><td class="py-3 font-bold">${i.receiptNo}</td><td>${i.qty}</td><td class="text-right"><button onclick="processTransaction('return','${i.id}')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-600 hover:text-white transition-all">คืน</button></td></tr>`).join('');
                return;
            }

            if(!tbody) return;
            let filtered = items;
            if(currentView==='report') filtered = items.filter(i=>!i.dateReported);
            else if(['dispose','return_customer'].includes(currentView)) filtered = items.filter(i => i.dateReported && i.disposalStatus!=='Completed' && calculateDaysRemaining(i.dateReported)>=60 && (currentView==='return_customer' ? i.disposalPref==='รับคืน' : i.disposalPref!=='รับคืน'));
            else if(currentView==='history') filtered = events;
            else if(currentView==='users') filtered = userList;

            const s = searchTerm.toLowerCase();
            const paged = filtered.filter(row => {
                 if(currentView==='users') return !s || row.username.toLowerCase().includes(s);
                 if(currentView==='history') return !s || row.itemName.toLowerCase().includes(s);
                 return !s || row.receiptNo.toLowerCase().includes(s);
            }).slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);

            tbody.innerHTML = paged.map(row => {
                if(currentView==='status') return `<tr><td class="p-4 font-bold text-slate-700">${row.receiptNo}</td><td>${row.qty}</td><td>${row.layer}</td><td><span class="px-2 py-1 rounded-lg text-xs font-black uppercase ${row.status==='Available'?'bg-emerald-100 text-emerald-700':'bg-red-100 text-red-700'}">${row.status}</span></td><td>${row.holder}</td><td class="text-xs text-slate-400">${row.params}</td><td class="text-xs text-blue-600">${formatDateTh(row.dateReported)}</td></tr>`;
                
                if(currentView==='items') return `<tr><td class="p-4"><input type="checkbox" class="item-checkbox" value="${row.id}" onchange="checkSelection('btn-delete-items')"></td><td class="p-4 font-bold text-slate-700">${row.receiptNo}</td><td>${row.qty}</td><td class="p-4 text-slate-500">${row.layer}</td><td>${formatDateTh(row.dateReceived)}</td><td class="text-xs">${row.disposalPref}</td><td class="p-4 text-center space-x-2"><button onclick='openItemModal(${JSON.stringify(row).replace(/'/g,"&apos;")})' class="text-blue-500 hover:scale-110 transition-transform"><i class="fa-solid fa-edit"></i></button><button onclick="deleteItem('${row.id}')" class="text-red-500 hover:scale-110 transition-transform"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                
                if(currentView==='report') return `<tr><td class="p-4 font-bold text-slate-700">${row.receiptNo}</td><td>${formatDateTh(row.dateReceived)}</td><td class="text-xs text-slate-500">${row.params}</td><td class="text-center"><button onclick="openReportDateModal('${row.id}','${row.receiptNo}')" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold shadow hover:bg-blue-700">ยืนยันผล</button></td></tr>`;
                
                if(['dispose','return_customer'].includes(currentView)) {
                    const chkId = currentView==='return_customer' ? 'btn-delete-return' : 'btn-delete-dispose';
                    return `<tr><td class="p-4"><input type="checkbox" class="item-checkbox" value="${row.id}" onchange="checkSelection('${chkId}')"></td><td class="p-4 font-bold text-slate-700">${row.receiptNo}</td><td>${row.qty}</td><td class="p-4 text-slate-500">${row.layer}</td><td>${formatDateTh(row.dateReported)}</td><td class="p-4 text-red-600 font-bold">${calculateDaysRemaining(row.dateReported)} วัน</td><td class="text-center"><button onclick="handleDisposeItem('${row.id}')" class="bg-orange-600 text-white px-3 py-1 rounded-lg text-xs font-bold shadow hover:bg-orange-700">ดำเนินการ</button></td></tr>`;
                }

                if(currentView==='history') return `<tr><td class="p-4">${currentUser.username==='admin'?`<input type="checkbox" class="item-checkbox" value="${row.id}" onchange="checkSelection('btn-delete-history')">`:''}</td><td class="whitespace-nowrap text-xs">${formatDateTh(row.date)}</td><td><span class="px-2 py-1 rounded text-[10px] font-bold ${row.type==='Borrow'?'bg-orange-100 text-orange-600':'bg-emerald-100 text-emerald-600'}">${row.type}</span></td><td class="font-mono font-bold">${row.itemName}</td><td class="font-bold">${row.user}</td><td class="text-xs text-slate-400">${getUserInfo(row.user).name}</td><td class="text-xs text-slate-400">${getUserInfo(row.user).group}</td><td class="text-xs">${row.note||'-'}</td><td class="text-center">${currentUser.username==='admin'?`<button onclick="deleteEvent('${row.id}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>`:''}</td></tr>`;
                
                if(currentView==='users') return `<tr><td class="p-4 font-bold">${row.username}</td><td>${row.name}</td><td>${row.group}</td><td><span class="px-2 py-1 rounded-full text-xs font-bold ${row.status==='Approved'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}">${row.status}</span></td><td class="text-center"><input type="checkbox" ${row.canReport?'checked':''} onchange="toggleUserPermission('${row.username}','report',this.checked)"></td><td class="text-center"><input type="checkbox" ${row.canManage?'checked':''} onchange="toggleUserPermission('${row.username}','manage',this.checked)"></td><td class="text-center"><input type="checkbox" ${row.canDispose?'checked':''} onchange="toggleUserPermission('${row.username}','dispose',this.checked)"></td><td class="text-center space-x-2">${row.status==='Pending'?`<button onclick="approveUser('${row.username}')" class="text-emerald-500"><i class="fa-solid fa-check"></i></button>`:''}<button onclick="deleteUser('${row.username}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                
                return '';
            }).join('');
            
            const pCont = document.getElementById('pagination-controls');
            if(pCont) pCont.innerHTML = renderPagination(filtered.length, 'changePage');
        }

        // --- 6. EXPORT FUNCTIONS ---
        async function exportViewPDF() {
            if (!window.jspdf) return alert('PDF Library Not Ready');
            const { jsPDF } = window.jspdf;
            const isLandscape = currentView === 'history';
            const doc = new jsPDF(isLandscape ? 'l' : 'p'); 
            const settings = docSettings[currentView] || { footerLeft: '', footerRight: '' };
            await loadThaiFont(doc);

            const titles = { 
                'items':'Soil Samples List', 
                'status':'Sample Status Report', 
                'report':'Pending Analysis Report', 
                'dispose':'Disposal List', 
                'return_customer':'Return List', 
                'history':'History Log', 
                'users':'User Management' 
            };
            
            doc.setFontSize(22);
            doc.text(titles[currentView] || 'Report', 14, 25);
            doc.setFontSize(10);
            doc.text(`Date: ${formatDateForPDF(new Date().toISOString())} | By: ${currentUser.name}`, 14, 35);
            doc.line(14, 40, isLandscape ? 283 : 196, 40);

            let headers = [], data = [];
            if(currentView === 'items') {
                headers = [["Receipt No", "Qty", "Layer", "Date Received", "Disposal", "Status"]];
                data = items.map(i => [i.receiptNo, i.qty, i.layer, formatDateForPDF(i.dateReceived), i.disposalPref, i.status]);
            } else if(currentView === 'status') {
                headers = [["Receipt No", "Qty", "Layer", "Status", "Holder", "Params", "Report Date"]];
                data = items.map(i => [i.receiptNo, i.qty, i.layer, i.status, i.holder, i.params, formatDateForPDF(i.dateReported)]);
            } else if(currentView === 'report') {
                headers = [["Receipt No", "Date Received", "Params"]];
                data = items.filter(i=>!i.dateReported).map(i => [i.receiptNo, formatDateForPDF(i.dateReceived), i.params]);
            } else if(currentView === 'history') {
                headers = [["Time", "Action", "Receipt No", "User", "Note"]];
                data = events.map(e => [formatDateTh(e.date), e.type, e.itemName, e.user, e.note]);
            } else if(currentView === 'dispose' || currentView === 'return_customer') {
                headers = [["Receipt No", "Qty", "Layer", "Report Date", "Overdue (Days)"]];
                const filtered = items.filter(i => i.dateReported && i.disposalStatus !== 'Completed' && calculateDaysRemaining(i.dateReported) >= 60 && (currentView === 'return_customer' ? i.disposalPref === 'รับคืน' : i.disposalPref !== 'รับคืน'));
                data = filtered.map(i => [i.receiptNo, i.qty, i.layer, formatDateForPDF(i.dateReported), calculateDaysRemaining(i.dateReported)]);
            } else if(currentView === 'users') {
                headers = [["Username", "Name", "Group", "Status"]];
                data = userList.map(u => [u.username, u.name, u.group, u.status]);
            }

            doc.autoTable({
                head: headers,
                body: data,
                startY: 45, // Adjusted startY
                styles: { font: 'Sarabun', fontSize: 10 },
                headStyles: { fillColor: [5, 150, 105] },
                didDrawPage: (d) => {
                    doc.setFontSize(9);
                    const pageHeight = doc.internal.pageSize.height;
                    const pageWidth = doc.internal.pageSize.width;
                    if(settings.footerLeft) doc.text(settings.footerLeft, 14, pageHeight - 10);
                    if(settings.footerRight) doc.text(settings.footerRight, pageWidth - 14, pageHeight - 10, { align: 'right' });
                    doc.text(`Page ${doc.internal.getNumberOfPages()}`, pageWidth - 14, pageHeight - 10, { align: 'right' });
                }
            });

            doc.save(`${currentView}_report.pdf`);
            hideLoading();
        }

        // --- 9. UTILS ---
        function openItemModal(item = null) {
            const isEdit = !!item;
            const html = `<div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6"><h3 class="text-xl font-bold mb-4">${isEdit ? 'แก้ไข' : 'เพิ่ม'}ตัวอย่าง</h3><form onsubmit="handleSaveItem(event, '${isEdit ? item.id : ''}')" class="space-y-3"><div class="grid grid-cols-2 gap-3"><div><label class="text-xs font-bold">เลขรับ</label><input type="text" id="m-receipt" value="${item?.receiptNo||''}" class="w-full border p-2 rounded" required></div><div><label class="text-xs font-bold">วันที่รับ</label><input type="date" id="m-date" value="${item?.dateReceived ? item.dateReceived.split('T')[0] : ''}" class="w-full border p-2 rounded" required></div></div><div class="grid grid-cols-2 gap-3"><div><label class="text-xs font-bold">จำนวน</label><input type="number" id="m-qty" value="${item?.qty||1}" class="w-full border p-2 rounded" required></div><div><label class="text-xs font-bold">ชั้น</label><input type="text" id="m-layer" value="${item?.layer?.replace(/'/g,'')||''}" class="w-full border p-2 rounded"></div></div><div><label class="text-xs font-bold">พารามิเตอร์</label><input type="text" id="m-params" value="${item?.params||''}" class="w-full border p-2 rounded"></div><div><label class="text-xs font-bold">ความต้องการ</label><select id="m-pref" class="w-full border p-2 rounded"><option value="ทิ้ง" ${item?.disposalPref==='ทิ้ง'?'selected':''}>ทิ้ง</option><option value="รับคืน" ${item?.disposalPref==='รับคืน'?'selected':''}>รับคืน</option></select></div><div class="flex justify-end gap-2 mt-4 border-t pt-4"><button type="button" onclick="document.getElementById('modal-container').innerHTML=''" class="px-4 py-2 text-gray-500">ยกเลิก</button><button type="submit" class="btn-primary">บันทึก</button></div></form></div></div>`;
            document.getElementById('modal-container').innerHTML = html;
        }

        async function handleSaveItem(e, id) {
            e.preventDefault();
            const payload = {
                id: id,
                receiptNo: document.getElementById('m-receipt').value,
                dateReceived: document.getElementById('m-date').value,
                qty: document.getElementById('m-qty').value,
                layer: "'" + document.getElementById('m-layer').value,
                params: document.getElementById('m-params').value,
                disposalPref: document.getElementById('m-pref').value
            };
            const action = id ? 'editItem' : 'addItem';
            const res = await apiCall(action, { item: payload });
            if(res.status==='success') { document.getElementById('modal-container').innerHTML=''; await refreshData(); router('items'); } else alert(res.message);
        }

        async function openSettingsModal(k) { document.getElementById('modal-container').innerHTML=`<div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white p-6 rounded-xl w-full max-w-sm"><h3 class="text-xl font-bold mb-4">ตั้งค่า PDF (${k})</h3><input type="text" id="set-l" class="w-full border p-2 rounded mb-2" placeholder="ซ้าย"><input type="text" id="set-r" class="w-full border p-2 rounded mb-4" placeholder="ขวา"><div class="flex justify-end gap-2"><button onclick="document.getElementById('modal-container').innerHTML=''" class="px-4 py-2 text-gray-500">ยกเลิก</button><button onclick="saveSettings('${k}')" class="btn-primary">บันทึก</button></div></div></div>`; }
        async function saveSettings(k) { docSettings[k]={footerLeft:document.getElementById('set-l').value, footerRight:document.getElementById('set-r').value}; const res=await apiCall('saveSettings',{type:k, settings:docSettings[k]}, false); if(res.status==='success') document.getElementById('modal-container').innerHTML=''; }

        function checkSelection(btnId) {
            const c = document.querySelectorAll('.item-checkbox:checked').length;
            const btn = document.getElementById(btnId);
            if(btn) {
                if(c > 0) { btn.classList.remove('hidden'); btn.querySelector('span') ? btn.querySelector('span').textContent = c : null; }
                else btn.classList.add('hidden');
            }
        }
        function toggleAllItems(src, btnId) { document.querySelectorAll('.item-checkbox').forEach(c => c.checked = src.checked); checkSelection(btnId); }
        async function deleteSelected(type) { const chk = document.querySelectorAll('.item-checkbox:checked'); if(chk.length === 0) return; if(!confirm(`ลบ ${chk.length} รายการ?`)) return; showLoading(); for(let c of chk) { await apiCall(type==='event'?'deleteEvent':'deleteItem', {id:c.value}, false); } hideLoading(); await refreshData(); router(currentView); }
        async function approveUser(u) { if(confirm('อนุมัติ?')) { await apiCall('approveUser',{username:u}); router('users'); } }
        async function deleteUser(u) { if(confirm('ลบ?')) { await apiCall('deleteUser',{username:u}); router('users'); } }
        async function toggleUserPermission(u,t,v) { await apiCall('toggleUserPermission',{username:u, type:t, value:v}); }
        async function handleDisposeItem(id) { if(confirm('ยืนยัน?')) { await apiCall('disposeItem',{id}); refreshData(); router(currentView); } }
        async function deleteItem(id) { if(confirm('ลบ?')) { await apiCall('deleteItem',{id}); refreshData(); router(currentView); } }
        async function deleteEvent(id) { if(confirm('ลบ?')) { await apiCall('deleteEvent',{id}); refreshData(); router('history'); } }
        function logout() { localStorage.removeItem('soilAppUser'); location.reload(); }
        function exportViewXLSX() { const wb = XLSX.utils.book_new(); const ws = XLSX.utils.json_to_sheet(currentView==='history'?events:items); XLSX.utils.book_append_sheet(wb, ws, "Data"); XLSX.writeFile(wb, `${currentView}.xlsx`); }

        // --- INIT ---
        function init() {
            setInterval(()=>{const d=new Date(); document.getElementById('clock').textContent=`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;}, 1000);
            updateStatusBadge();
            const u = localStorage.getItem('soilAppUser');
            if(u) { try { currentUser=JSON.parse(u); document.getElementById('login-screen').classList.add('hidden'); updateNavAndRedirect(); } catch(e) { localStorage.removeItem('soilAppUser'); } }
        }
        
        window.onload = init;
    </script>
</body>
</html>
